import{_ as e,a as t,o as r,b as n}from"./index-min.js";var o=function(e,t){return o=Object.setPrototypeOf||{__proto__:[]}instanceof Array&&function(e,t){e.__proto__=t}||function(e,t){for(var r in t)Object.prototype.hasOwnProperty.call(t,r)&&(e[r]=t[r])},o(e,t)};var a=function(){return a=Object.assign||function(e){for(var t,r=1,n=arguments.length;r<n;r++)for(var o in t=arguments[r])Object.prototype.hasOwnProperty.call(t,o)&&(e[o]=t[o]);return e},a.apply(this,arguments)};function i(e){var t="function"==typeof Symbol&&Symbol.iterator,r=t&&e[t],n=0;if(r)return r.call(e);if(e&&"number"==typeof e.length)return{next:function(){return e&&n>=e.length&&(e=void 0),{value:e&&e[n++],done:!e}}};throw new TypeError(t?"Object is not iterable.":"Symbol.iterator is not defined.")}"function"==typeof SuppressedError&&SuppressedError;var s="is",c="is not",u="contains",l="does not contain",f="less",h="less or equal",v="greater",p="greater or equal",y="version less",d="version less or equal",m="version greater",g="version greater or equal",b="set is",w="set is not",S="set contains",x="set does not contain",C="set contains any",T="set does not contain any",A="regex match",E="regex does not match",O=-862048943,j=461845907,I=function(e,t){void 0===t&&(t=0);for(var r=function(e){for(var t=[],r=0,n=0;n<e.length;n++){var o=e.charCodeAt(n);o<128?t[r++]=o:o<2048?(t[r++]=o>>6|192,t[r++]=63&o|128):55296==(64512&o)&&n+1<e.length&&56320==(64512&e.charCodeAt(n+1))?(o=65536+((1023&o)<<10)+(1023&e.charCodeAt(++n)),t[r++]=o>>18|240,t[r++]=o>>12&63|128,t[r++]=o>>6&63|128,t[r++]=63&o|128):(t[r++]=o>>12|224,t[r++]=o>>6&63|128,t[r++]=63&o|128)}return Uint8Array.from(t)}(e),n=r.length,o=n>>2,a=t,i=0;i<o;i++){var s=k(r,i<<2);a=N(s,a)}var c=o<<2,u=0;switch(n-c){case 3:u^=r[c+2]<<16,u^=r[c+1]<<8,u^=r[c],u=Math.imul(u,O),u=_(u,15),a^=u=Math.imul(u,j);break;case 2:u^=r[c+1]<<8,u^=r[c],u=Math.imul(u,O),u=_(u,15),a^=u=Math.imul(u,j);break;case 1:u^=r[c],u=Math.imul(u,O),u=_(u,15),a^=u=Math.imul(u,j)}return R(a^=n)>>>0},N=function(e,t){var r=e,n=t;return r=Math.imul(r,O),r=_(r,15),r=Math.imul(r,j),n=_(n^=r,13),(n=Math.imul(n,5))+-430675100|0},R=function(e){var t=e;return t^=t>>>16,t=Math.imul(t,-2048144789),t^=t>>>13,t=Math.imul(t,-1028477387),t^=t>>>16},_=function(e,t,r){return void 0===r&&(r=32),t>r&&(t%=r),(e<<t|(e&4294967295<<r-t>>>0)>>>0>>>r-t>>>0)>>>0},k=function(e,t){void 0===t&&(t=0);var r=e[t]<<24|e[t+1]<<16|e[t+2]<<8|e[t+3];return P(r)},P=function(e){return(-16777216&e)>>>24|(16711680&e)>>>8|(65280&e)<<8|(255&e)<<24},F=function(e,t){var r,n;if(t&&0!==t.length){try{for(var o=i(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(!s||!e||"object"!=typeof e)return;e=e[s]}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return e||void 0}},M="^".concat("(\\d+)\\.(\\d+)","(\\.").concat("(\\d+)").concat("(-(([-\\w]+\\.?)*))?",")?$"),q=function(){function e(e,t,r,n){void 0===n&&(n=void 0),this.major=e,this.minor=t,this.patch=r,this.preRelease=n}return e.parse=function(t){if(t){var r=new RegExp(M).exec(t);if(r){var n=Number(r[1]),o=Number(r[2]);if(!isNaN(n)&&!isNaN(o))return new e(n,o,Number(r[4])||0,r[5]||void 0)}}},e.prototype.compareTo=function(e){return this.major>e.major?1:this.major<e.major?-1:this.minor>e.minor?1:this.minor<e.minor?-1:this.patch>e.patch?1:this.patch<e.patch||this.preRelease&&!e.preRelease?-1:!this.preRelease&&e.preRelease?1:this.preRelease&&e.preRelease?this.preRelease>e.preRelease?1:this.preRelease<e.preRelease?-1:0:0},e}(),B=function(){function e(){}return e.prototype.evaluate=function(e,t){var r,n,o={},a={context:e,result:o};try{for(var s=i(t),c=s.next();!c.done;c=s.next()){var u=c.value,l=this.evaluateFlag(a,u);l&&(o[u.key]=l)}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return o},e.prototype.evaluateFlag=function(e,t){var r,n,o;try{for(var s=i(t.segments),c=s.next();!c.done;c=s.next()){var u=c.value;if(o=this.evaluateSegment(e,t,u)){var l=a(a(a({},t.metadata),u.metadata),o.metadata);o=a(a({},o),{metadata:l});break}}}catch(e){r={error:e}}finally{try{c&&!c.done&&(n=s.return)&&n.call(s)}finally{if(r)throw r.error}}return o},e.prototype.evaluateSegment=function(e,t,r){var n,o,a,s;if(!r.conditions)return void 0!==(l=this.bucket(e,r))?t.variants[l]:void 0;try{for(var c=i(r.conditions),u=c.next();!u.done;u=c.next()){var l,f=u.value,h=!0;try{for(var v=(a=void 0,i(f)),p=v.next();!p.done;p=v.next()){var y=p.value;if(!(h=this.matchCondition(e,y)))break}}catch(e){a={error:e}}finally{try{p&&!p.done&&(s=v.return)&&s.call(v)}finally{if(a)throw a.error}}if(h)return void 0!==(l=this.bucket(e,r))?t.variants[l]:void 0}}catch(e){n={error:e}}finally{try{u&&!u.done&&(o=c.return)&&o.call(c)}finally{if(n)throw n.error}}},e.prototype.matchCondition=function(e,t){var r=F(e,t.selector);if(r){if(this.isSetOperator(t.op)){var n=this.coerceStringArray(r);return!!n&&this.matchSet(n,t.op,t.values)}var o=this.coerceString(r);return void 0!==o&&this.matchString(o,t.op,t.values)}return this.matchNull(t.op,t.values)},e.prototype.getHash=function(e){return I(e)},e.prototype.bucket=function(e,t){var r,n,o,a;if(!t.bucket)return t.variant;var s=this.coerceString(F(e,t.bucket.selector));if(!s||0===s.length)return t.variant;var c="".concat(t.bucket.salt,"/").concat(s),u=this.getHash(c),l=u%100,f=Math.floor(u/100);try{for(var h=i(t.bucket.allocations),v=h.next();!v.done;v=h.next()){var p=v.value,y=p.range[0],d=p.range[1];if(l>=y&&l<d)try{for(var m=(o=void 0,i(p.distributions)),g=m.next();!g.done;g=m.next()){var b=g.value,w=b.range[0],S=b.range[1];if(f>=w&&f<S)return b.variant}}catch(e){o={error:e}}finally{try{g&&!g.done&&(a=m.return)&&a.call(m)}finally{if(o)throw o.error}}}}catch(e){r={error:e}}finally{try{v&&!v.done&&(n=h.return)&&n.call(h)}finally{if(r)throw r.error}}return t.variant},e.prototype.matchNull=function(e,t){var r=this.containsNone(t);switch(e){case s:case u:case f:case h:case v:case p:case y:case d:case m:case g:case b:case S:case C:return r;case c:case l:case x:case T:return!r;default:return!1}},e.prototype.matchSet=function(e,t,r){switch(t){case b:return this.setEquals(e,r);case w:return!this.setEquals(e,r);case S:return this.matchesSetContainsAll(e,r);case x:return!this.matchesSetContainsAll(e,r);case C:return this.matchesSetContainsAny(e,r);case T:return!this.matchesSetContainsAny(e,r);default:return!1}},e.prototype.matchString=function(e,t,r){var n=this;switch(t){case s:return this.matchesIs(e,r);case c:return!this.matchesIs(e,r);case u:return this.matchesContains(e,r);case l:return!this.matchesContains(e,r);case f:case h:case v:case p:return this.matchesComparable(e,t,r,(function(e){return n.parseNumber(e)}),this.comparator);case y:case d:case m:case g:return this.matchesComparable(e,t,r,(function(e){return q.parse(e)}),this.versionComparator);case A:return this.matchesRegex(e,r);case E:return!this.matchesRegex(e,r);default:return!1}},e.prototype.matchesIs=function(e,t){if(this.containsBooleans(t)){var r=e.toLowerCase();if("true"===r||"false"===r)return t.some((function(e){return e.toLowerCase()===r}))}return t.some((function(t){return e===t}))},e.prototype.matchesContains=function(e,t){var r,n;try{for(var o=i(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(e.toLowerCase().includes(s.toLowerCase()))return!0}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return!1},e.prototype.matchesComparable=function(e,t,r,n,o){var a=this,i=n(e),s=r.map((function(e){return n(e)})).filter((function(e){return void 0!==e}));return void 0===i||0===s.length?r.some((function(r){return a.comparator(e,t,r)})):s.some((function(e){return o(i,t,e)}))},e.prototype.comparator=function(e,t,r){switch(t){case f:case y:return e<r;case h:case d:return e<=r;case v:case m:return e>r;case p:case g:return e>=r;default:return!1}},e.prototype.versionComparator=function(e,t,r){var n=e.compareTo(r);switch(t){case f:case y:return n<0;case h:case d:return n<=0;case v:case m:return n>0;case p:case g:return n>=0;default:return!1}},e.prototype.matchesRegex=function(e,t){return t.some((function(t){return Boolean(new RegExp(t).exec(e))}))},e.prototype.containsNone=function(e){return e.some((function(e){return"(none)"===e}))},e.prototype.containsBooleans=function(e){return e.some((function(e){switch(e.toLowerCase()){case"true":case"false":return!0;default:return!1}}))},e.prototype.parseNumber=function(e){var t;return null!==(t=Number(e))&&void 0!==t?t:void 0},e.prototype.coerceString=function(e){if(e)return"object"==typeof e?JSON.stringify(e):String(e)},e.prototype.coerceStringArray=function(e){var t=this;if(Array.isArray(e))return e.map((function(e){return t.coerceString(e)})).filter(Boolean);var r=String(e);try{var n=JSON.parse(r);return Array.isArray(n)?e.map((function(e){return t.coerceString(e)})).filter(Boolean):void 0}catch(e){return}},e.prototype.isSetOperator=function(e){switch(e){case b:case w:case S:case x:case C:case T:return!0;default:return!1}},e.prototype.setEquals=function(e,t){var r=new Set(e),n=new Set(t);return r.size===n.size&&function(e,t,r){if(r||2===arguments.length)for(var n,o=0,a=t.length;o<a;o++)!n&&o in t||(n||(n=Array.prototype.slice.call(t,0,o)),n[o]=t[o]);return e.concat(n||Array.prototype.slice.call(t))}([],function(e,t){var r="function"==typeof Symbol&&e[Symbol.iterator];if(!r)return e;var n,o,a=r.call(e),i=[];try{for(;(void 0===t||t-- >0)&&!(n=a.next()).done;)i.push(n.value)}catch(e){o={error:e}}finally{try{n&&!n.done&&(r=a.return)&&r.call(a)}finally{if(o)throw o.error}}return i}(n),!1).every((function(e){return r.has(e)}))},e.prototype.matchesSetContainsAll=function(e,t){var r,n;if(e.length<t.length)return!1;try{for(var o=i(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(!this.matchesIs(s,e))return!1}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return!0},e.prototype.matchesSetContainsAny=function(e,t){var r,n;try{for(var o=i(t),a=o.next();!a.done;a=o.next()){var s=a.value;if(this.matchesIs(s,e))return!0}}catch(e){r={error:e}}finally{try{a&&!a.done&&(n=o.return)&&n.call(o)}finally{if(r)throw r.error}}return!1},e}();"function"==typeof TextDecoder&&new TextDecoder,"function"==typeof TextEncoder&&new TextEncoder;const L=Array.prototype.slice.call("ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789+/=");(()=>{let e={};L.forEach(((t,r)=>e[t]=r))})(),String.fromCharCode.bind(String),"function"==typeof Uint8Array.from&&Uint8Array.from.bind(Uint8Array),function(e){function t(r,n){var o=e.call(this,n)||this;return o.statusCode=r,Object.setPrototypeOf(o,t.prototype),o}(function(e,t){if("function"!=typeof t&&null!==t)throw new TypeError("Class extends value "+String(t)+" is not a constructor or null");function r(){this.constructor=e}o(e,t),e.prototype=null===t?Object.create(t):(r.prototype=t.prototype,new r)})(t,e)}(Error);var D=new function(){var o=this;this.dbs={},this.createStore=function(n){return e(o,void 0,void 0,(function(){return t(this,(function(e){switch(e.label){case 0:return[4,r(n,1,{upgrade:function(e){e.objectStoreNames.contains("eventTypesForSession")||e.createObjectStore("eventTypesForSession",{keyPath:"sessionId"})}})];case 1:return[2,e.sent()]}}))}))},this.openOrCreateDB=function(r){return e(o,void 0,void 0,(function(){var e,n;return t(this,(function(t){switch(t.label){case 0:return this.dbs&&this.dbs[r]?[2,this.dbs[r]]:(e="".concat(r.substring(0,10),"_amp_targeting"),[4,this.createStore(e)]);case 1:return n=t.sent(),this.dbs[r]=n,[2,n]}}))}))},this.updateEventListForSession=function(r){var a=r.sessionId,i=r.eventType,s=r.eventTime,c=r.loggerProvider,u=r.tx;return e(o,void 0,void 0,(function(){var e,r,o,l,f,h,v,p,y;return t(this,(function(t){switch(t.label){case 0:return t.trys.push([0,3,,4]),e=String(a),[4,u.store.get(e)];case 1:return r=t.sent(),o=r?r.eventTypes:{},l=o[i]||{},f=n(n({},o),((p={})[i]=n(n({},l),((y={})[s]={event_type:i},y)),p)),h={sessionId:e,eventTypes:f,lastUpdated:Date.now()},[4,u.store.put(h)];case 2:return t.sent(),[2,f];case 3:return v=t.sent(),c.warn("Failed to store events for targeting ".concat(a,": ").concat(v)),[3,4];case 4:return[2,void 0]}}))}))},this.deleteOldSessionEventTypes=function(r){var n=r.currentSessionId,a=r.loggerProvider,i=r.tx;return e(o,void 0,void 0,(function(){var e,r,o,s,c,u;return t(this,(function(t){switch(t.label){case 0:return t.trys.push([0,6,,7]),e=String(n),[4,i.store.getAll()];case 1:r=t.sent(),o=0,t.label=2;case 2:return o<r.length?(s=r[o],c=Date.now()-s.lastUpdated,s.sessionId!==e&&c>1728e5?[4,i.store.delete(s.sessionId)]:[3,4]):[3,5];case 3:t.sent(),t.label=4;case 4:return o++,[3,2];case 5:return[3,7];case 6:return u=t.sent(),a.warn("Failed to clear old session event types for targeting: ".concat(u)),[3,7];case 7:return[2]}}))}))},this.storeEventTypeForSession=function(r){var n=r.loggerProvider,a=r.sessionId,i=r.eventType,s=r.eventTime,c=r.apiKey;return e(o,void 0,void 0,(function(){var e,r,o,u;return t(this,(function(t){switch(t.label){case 0:return t.trys.push([0,5,,6]),[4,this.openOrCreateDB(c)];case 1:return e=t.sent(),(r=e.transaction("eventTypesForSession","readwrite"))?[4,this.updateEventListForSession({sessionId:a,tx:r,loggerProvider:n,eventType:i,eventTime:s})]:[2];case 2:return o=t.sent(),[4,this.deleteOldSessionEventTypes({currentSessionId:a,tx:r,loggerProvider:n})];case 3:return t.sent(),[4,r.done];case 4:return t.sent(),[2,o];case 5:return u=t.sent(),n.warn("Failed to store events for targeting ".concat(a,": ").concat(u)),[3,6];case 6:return[2,void 0]}}))}))}},U=function(){var r=this;this.evaluateTargeting=function(n){var o=n.apiKey,a=n.loggerProvider,i=n.event,s=n.sessionId,c=n.userProperties,u=n.deviceId,l=n.flag;return e(r,void 0,void 0,(function(){var e,r,n,f;return t(this,(function(t){switch(t.label){case 0:return i&&i.time?[4,D.storeEventTypeForSession({loggerProvider:a,apiKey:o,sessionId:s,eventType:i.event_type,eventTime:i.time})]:[3,2];case 1:return r=t.sent(),[3,3];case 2:r=void 0,t.label=3;case 3:return n=(e=r)&&new Set(Object.keys(e)),f={session_id:s,event:i,event_types:n&&Array.from(n),user:{device_id:u,user_properties:c}},[2,this.evaluationEngine.evaluate(f,[l])]}}))}))},this.evaluationEngine=new B},K=function(){var e=new U;return{evaluateTargeting:e.evaluateTargeting.bind(e)}}().evaluateTargeting;export{K as evaluateTargeting};
//# sourceMappingURL=index-min2.js.map
